<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <script defer src="https://unpkg.com/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link rel=stylesheet href="style.css" />
  <script>
		function remove_timer(timers, timer_id) {
		  timers.splice(timers.find(item => item.timer_id = timer_id), 1);
		}

	  function c14n_timers(timers) {
				// sort by end
				timers.sort((a,b) => a.end > b.end)

				// remove old
				var now = Date.now();
				var i = -1;
				while (true) {
						  i = timers.findIndex(timer => timer.end <= now);
						  if ( i == -1 ) { break; }
						  timers.splice(i, 1);
						  continue;
					  }
			}

	  function add_endtime(timers, form) {
				var timer_id = timers.reduce((max, timer) => timer.timer_id > max ? timer.timer_id : max, -1);
				timer_id++;
				var now = Date.now()
				var newend = new Date();
				newend.setHours(parseInt(form.endtime.value.substr(0, 2), 10), parseInt(form.endtime.value.substr(3, 5), 10));
				newend = newend.getTime();
				timers.push({timer_id: timer_id, start: now, end: newend});
				c14n_timers(timers);
			}

	  function add_countdown(timers, form) {
				var timer_id = timers.reduce((max, timer) => timer.timer_id > max ? timer.timer_id : max, -1);
				timer_id++;
				var now = Date.now();
				var minutes = parseInt(form.minutes.value, 10);
				var newend = now + minutes*60;
				timers.push({timer_id: timer_id, start: now, end: newend});
				c14n_timers(timers);
			}

  </script>
</head>
<body>

<div x-data="{ timers: $persist([])}">
	<template x-for="timer in timers" :key="timer.timer_id">
		<div x-data="{ timer_id: timer.timer_id, start: new Date(timer.start), end: new Date(timer.end), duration: timer.end-timer.start }">
		Start: <span x-text="`${start.getHours().toString().padStart(2, '0')}:${start.getMinutes().toString().padStart(2, '0')}`"></span>, end <span x-text="`${end.getHours().toString().padStart(2, '0')}:${end.getMinutes().toString().padStart(2, '0')}`"></span>.
			<button @click="remove_timer(timers, timer_id)">Delete</button>
		<div>
	</template>

	<div id=add_forms>
		<form name=add_end_time @submit.prevent="add_endtime(timers, $event.target)">
			Endtime: <input type=time name=endtime value="18:00">
			<button submit>Add</button>
		</form>
		<form name=add_countdown @submit.prevent="add_countdown(timers, $event.target)">
			Endtime: <input type=number name=minutes value=60 >
			<button submit>Add</button>
		</form>
	</div>

</div>

</div>

</body>
</html>
